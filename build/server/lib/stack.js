// Generated by CoffeeScript 1.8.0
var Client, addInDatabase, config, controllerAdded, fs, log, path, permission;

fs = require('fs');

path = require('path');

Client = require('request-json-light').JsonClient;

log = require('printit')();

config = require('./conf').get;

permission = require('../middlewares/token');

controllerAdded = false;

addInDatabase = function(app) {
  var clientDS;
  clientDS = new Client("http://localhost:9101");
  clientDS.setBasicAuth('home', permission.get());
  return clientDS.post('/request/stackapplication/all/', {}, function(err, res, body) {
    var appli, application, _i, _len;
    application = null;
    if (err == null) {
      for (_i = 0, _len = body.length; _i < _len; _i++) {
        appli = body[_i];
        appli = appli.value;
        if (appli.name === app.name) {
          application = appli;
        }
      }
    }
    if (application !== null) {
      return clientDS.put("/data/" + application._id + "/ ", app, function(err, res, body) {
        if (err != null) {
          log.warn("Error in updating " + app.name + " to database");
          return log.warn(err);
        } else {
          return controllerAdded = true;
        }
      });
    } else {
      return clientDS.post('/data/', app, function(err, res, body) {
        if (err != null) {
          log.warn("Error in adding " + app.name + " to database");
          return log.warn(err);
        } else {
          return controllerAdded = true;
        }
      });
    }
  });
};


/*
    Add application <app> in stack.json
        * read stack file
        * parse date (in json)
        * add application <app>
        * write stack file with new stack applications
 */

module.exports.addApp = function(app, callback) {
  var clientDS, data;
  clientDS = new Client("http://localhost:9101");
  clientDS.setBasicAuth('home', permission.get());
  app.docType = "StackApplication";
  data = require(path.join(config('dir_source'), app.name, 'package.json'));
  app.version = data.version;
  addInDatabase(app);
  if (!controllerAdded) {
    data = require(path.join(__dirname, '..', '..', '..', 'package.json'));
    app = {
      docType: "StackApplication",
      name: "controller",
      version: data.version
    };
    addInDatabase(app);
  }
  return fs.readFile(config('file_stack'), 'utf8', function(err, data) {
    try {
      data = JSON.parse(data);
    } catch (_error) {
      data = {};
    }
    data[app.name] = app;
    return fs.open(config('file_stack'), 'w', function(err, fd) {
      return fs.write(fd, JSON.stringify(data), 0, data.length, 0, callback);
    });
  });
};


/*
    Add controller in database
 */

module.exports.addController = function() {
  var app, data;
  data = require(path.join(__dirname, '..', '..', '..', 'package.json'));
  app = {
    docType: "StackApplication",
    name: "controller",
    version: data.version
  };
  return addInDatabase(app);
};


/*
    Remove application <name> from stack.json
        * read stack file
        * parse date (in json)
        * remove application <name>
        * write stack file with new stack applications
 */

module.exports.removeApp = function(name, callback) {
  return fs.readFile(config('file_stack'), 'utf8', function(err, data) {
    try {
      data = JSON.parse(data);
    } catch (_error) {
      data = {};
    }
    delete data[name];
    return fs.open(config('file_stack'), 'w', function(err, fd) {
      return fs.write(fd, JSON.stringify(data), 0, data.length, 0, callback);
    });
  });
};
