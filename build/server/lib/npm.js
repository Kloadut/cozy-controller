// Generated by CoffeeScript 1.9.1
var config, log, npm, path, spawn;

path = require('path');

spawn = require('child_process').spawn;

log = require('printit')();

config = require('./conf').get;

npm = require('npm');


/*
  Install dependencies
      * Use strict-ssl or specific npm_registry in function of configuration
      * Npm install
      * Remove npm cache
 */

module.exports.install = function(connection, target, callback) {
  var conf;
  setTimeout(function() {
    var err;
    log.error("npm:install:err: NPM Install failed :Timeout");
    err = new Error('NPM Install failed : timeout');
    callback(err);
    return callback = null;
  }, 10 * 60 * 1000);
  conf = {
    'production': true,
    'loglevel': 'silent',
    'global': false
  };
  if (config('npm_registry')) {
    config.registry = config('npm_registry');
  }
  if (config('npm_strict_ssl')) {
    config['strict-ssl'] = config('npm_strict_ssl');
  }
  return npm.load(conf, function(err) {
    npm.prefix = target.dir;
    return npm.commands.install([], function(err) {
      return npm.commands.cache.clean([], function(error) {
        if (err) {
          log.error("npm:install:err: NPM Install failed : " + stderr);
          err = new Error('NPM Install failed');
          return callback(stderr);
        } else {
          log.info('npm:install:success');
          return callback();
        }
      });
    });
  });
};
